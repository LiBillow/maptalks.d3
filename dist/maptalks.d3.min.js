/*!
 * maptalks.d3 v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function o(t,e){for(var o=Object.getOwnPropertyNames(e),r=0;r<o.length;r++){var n=o[r],i=Object.getOwnPropertyDescriptor(e,n);i&&i.configurable&&void 0===t[n]&&Object.defineProperty(t,n,i)}return t}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):o(t,e))}function s(){var t="http://www.w3.org/2000/svg",e=document.createElementNS(t,"svg");e.style.overflow="",e.style.position="absolute",e.setAttribute("xmlns",t);var o=document.createElementNS(t,"defs");return e.appendChild(o),e.defs=o,e}var a={container:"front",renderer:"dom",hideWhenZooming:!1},h=function(t){function e(o,i){return r(this,e),n(this,t.call(this,o,i))}return i(e,t),e.prototype.isCanvasRender=function(){return"canvas"===this.options.renderer},e.prototype.prepareToDraw=function(){return null},e.prototype.draw=function(){return this},e.prototype.redraw=function(){return this.isCanvasRender()&&this._getRenderer().requestMapToRender(),this},e.prototype.getContext=function(){return this._getRenderer().context},e.prototype.getSize=function(){return this.getMap().getSize()},e.prototype.getGeoProjection=function(){return this._getRenderer().getGeoProjection()},e}(e.Layer);h.mergeOptions(a),h.registerRenderer("dom",function(){function t(e){r(this,t),this.layer=e,this._initContainer()}return t.prototype.getMap=function(){return this.layer.getMap()},t.prototype.render=function(){return this._drawed||(this.layer.draw(this.layer.getContext(),this.layer.getGeoProjection()),this._drawed=!0),this.layer.fire("layerload"),!0},t.prototype.setZIndex=function(t){this._zIndex=t,this._layerContainer.style.zIndex=100+t},t.prototype.getEvents=function(){return{zoomend:this.onZoomEnd,zoomstart:this.onZoomStart,moveend:this._refreshViewBox,resize:this._refreshViewBox,zooming:this.onZooming}},t.prototype.onZoomEnd=function(){this._resetContainer(),!this.layer.options.hideWhenZooming&&this._canTransform()||(this._layerContainer.style.display="")},t.prototype.onZoomStart=function(){!this.layer.options.hideWhenZooming&&this._canTransform()||(this._layerContainer.style.display="none")},t.prototype.onZooming=function(t){e.DomUtil.setTransformMatrix(this._layerContainer,t.matrix.container)},t.prototype.getGeoProjection=function(){var t=this.getMap();this._d3zoom||(this._d3zoom=t.getZoom());var o=this;return function(r,n){r[0]&&r[1]&&(r=[r[0],r[1]]);var i=t.coordinateToPoint(new e.Coordinate(r,n),o._d3zoom);return this&&this.stream&&this.stream.point(i.x,i.y),[i.x,i.y]}},t.prototype._canTransform=function(){return e.Browser.any3d||e.Browser.ie9},t.prototype._getContainerPos=function(){var t=this.getMap(),e=t.getCenter(),o=this._d3zoom||t.getZoom(),r=t.coordinateToPoint(e,o),n=1;return[r,n]},t.prototype._initContainer=function(){var t=this.getMap();this._layerContainer=e.DomUtil.createElOn("div","position:absolute;left:0px;top:0px;"),this.context=s(),this._layerContainer.appendChild(this.context),this._resetContainer();var o="front"===this.layer.options.container?t._panels.frontLayer:t._panels.backLayer;o.appendChild(this._layerContainer)},t.prototype._resetContainer=function(){this.context.style.transform="",this._refreshViewBox()},t.prototype._refreshViewBox=function(){var t=this.getMap(),e=t.getSize(),o=t._getResolution(),r=this._d3zoom||t.getZoom(),n=t._getResolution(r),i=o/n;this.context.setAttribute("width",e.width),this.context.setAttribute("height",e.height);var s=t.coordinateToPoint(t.getCenter(),r);this._viewBox=[s.x-e.width*i/2,s.y-e.height*i/2,e.width*i,e.height*i],this.context.setAttribute("viewBox",this._viewBox.join(" ")),this._layerContainer.style.transform="";var a=t.offsetPlatform();this._layerContainer.style.left=-a.x+"px",this._layerContainer.style.top=-a.y+"px"},t}()),h.registerRenderer("canvas",function(t){function o(){return r(this,o),n(this,t.apply(this,arguments))}return i(o,t),o.prototype.remove=function(){delete this._drawContext,e.renderer.Canvas.prototype.remove.call(this)},o.prototype.getGeoProjection=function(){var t=this.getMap();return function(o,r){o[0]&&o[1]&&(o=[o[0],o[1]]);var n=t.coordinateToContainerPoint(new e.Coordinate(o,r));return this&&this.stream&&this.stream.point(n.x,n.y),[n.x,n.y]}},o.prototype.draw=function(){this.prepareCanvas(),this._predrawed||(this._armContext(),this._drawContext=this.layer.prepareToDraw(this.context,this.layer.getGeoProjection()),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0),this.layer.draw.apply(this.layer,[this.context,this.layer.getGeoProjection()].concat(this._drawContext)),this.completeRender()},o.prototype._armContext=function(){if(this.context){var t=this.getMap();this.context.arcInMeter=function(e,o,r,n,i,s){var a=t.distanceToPixel(r,0);return this.arc(e,o,a.width,n,i,s)},this.context.arcToInMeter=function(e,o,r,n,i){var s=t.distanceToPixel(i,0);return this.arcTo(e,o,r,n,s.width)},this.context.ellipse&&(this.context.ellispeInMeter=function(e,o,r,n,i,s,a,h){var p=t.distanceToPixel(r,n);return this.ellipse(e,o,p.width,p.height,i,s,a,h)}),this.context.rectInMeter=function(e,o,r,n){var i=t.distanceToPixel(r,n);return this.rect(e,o,i.width,i.height)}}},o}(e.renderer.CanvasRenderer)),t.D3Layer=h,Object.defineProperty(t,"__esModule",{value:!0})});