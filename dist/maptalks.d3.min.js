/*!
 * maptalks.d3 v0.2.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@^0.23.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("d3")):"function"==typeof define&&define.amd?define(["exports","maptalks","d3"],e):e(t.maptalks=t.maptalks||{},t.maptalks,t.d3)}(this,function(t,e,o){"use strict";function r(t,e){for(var o=Object.getOwnPropertyNames(e),r=0;r<o.length;r++){var n=o[r],i=Object.getOwnPropertyDescriptor(e,n);i&&i.configurable&&void 0===t[n]&&Object.defineProperty(t,n,i)}return t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}function a(){var t="http://www.w3.org/2000/svg",e=document.createElementNS(t,"svg");e.style.overflow="",e.style.position="absolute",e.setAttribute("xmlns",t);var o=document.createElementNS(t,"defs");return e.appendChild(o),e.defs=o,e}var h=e.DomUtil.TRANSFORM,p={d3Version:4,container:"front",renderer:"canvas",hideWhenZooming:!1},l=function(t){function e(o,r){return n(this,e),i(this,t.call(this,o,r))}return s(e,t),e.prototype.isCanvasRender=function(){return"canvas"===this.options.renderer},e.prototype.prepareToDraw=function(){return null},e.prototype.draw=function(){return this},e.prototype.redraw=function(){return this.isCanvasRender()&&this._getRenderer().requestMapToRender(),this},e.prototype.getContext=function(){return this._getRenderer().context},e.prototype.getGeoProjection=function(){return this._getRenderer().getGeoProjection()},e}(e.Layer);l.mergeOptions(p),l.registerRenderer("dom",function(){function t(e){n(this,t),this.layer=e,this._initContainer()}return t.prototype.getMap=function(){return this.layer.getMap()},t.prototype.render=function(){if(this._predrawn||(this._drawContext=this.layer.prepareToDraw(this.context,this.layer.getGeoProjection()),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawn=!0),!this._drawed){var t=[this.layer.getContext(),this.layer.getGeoProjection()].concat(this._drawContext);this.layer.draw.apply(this.layer,t),this._drawed=!0}return this.layer.fire("layerload"),!0},t.prototype.setZIndex=function(t){this._zIndex=t,this._layerContainer.style.zIndex=100+t},t.prototype.getEvents=function(){return{zoomend:this.onZoomEnd,zoomstart:this.onZoomStart,moving:this.onMoving,moveend:this._refreshViewBox,resize:this._refreshViewBox,zooming:this.onZooming,pitch:this._refreshViewBox,rotate:this._refreshViewBox}},t.prototype.onMoving=function(){this.getMap().getPitch()&&this._refreshViewBox()},t.prototype.onZoomEnd=function(){this._resetContainer(),(this.layer.options.hideWhenZooming||!this._canTransform()||this.getMap().domCssMatrix)&&(this._layerContainer.style.display="")},t.prototype.onZoomStart=function(){(this.layer.options.hideWhenZooming||!this._canTransform()||this.getMap().domCssMatrix)&&(this._layerContainer.style.display="none")},t.prototype.onZooming=function(t){"none"!==this._layerContainer.style.display&&e.DomUtil.setTransformMatrix(this._layerContainer,t.matrix.container)},t.prototype.getGeoProjection=function(){var t=this.getMap();this._d3zoom||(this._d3zoom=t.getZoom());var r=this,n=this.layer.options.d3Version,i=function(o,n){o[0]&&o[1]&&(o=[o[0],o[1]]);var i=t.coordinateToPoint(new e.Coordinate(o,n),r._d3zoom);return this&&this.stream&&this.stream.point(i.x,i.y),[i.x,i.y]};return 3===n?i:4===n?o.geoTransform({point:i}):null},t.prototype.remove=function(){delete this.context,e.DomUtil.removeDomNode(this._layerContainer),delete this._layerContainer,delete this._viewBox,delete this._d3zoom,delete this.layer},t.prototype._canTransform=function(){return e.Browser.any3d||e.Browser.ie9},t.prototype._getContainerPos=function(){var t=this.getMap(),e=t.getCenter(),o=this._d3zoom||t.getZoom(),r=t.coordinateToPoint(e,o),n=1;return[r,n]},t.prototype._initContainer=function(){var t=this.getMap();this._layerContainer=e.DomUtil.createElOn("div","position:absolute;left:0px;top:0px;"),this.context=a(),this._layerContainer.appendChild(this.context),this._resetContainer();var o="front"===this.layer.options.container?t._panels.frontLayer:t._panels.backLayer;o.appendChild(this._layerContainer)},t.prototype._resetContainer=function(){this.context.style.transform="",this._refreshViewBox()},t.prototype._refreshViewBox=function(){var t=this.getMap(),o=t.getSize(),r=t._getResolution(),n=this._d3zoom||t.getZoom(),i=t._getResolution(n),s=r/i;this.context.setAttribute("width",o.width),this.context.setAttribute("height",o.height);var a=t.coordinateToPoint(t.getCenter(),n);this._viewBox=[a.x-o.width*s/2,a.y-o.height*s/2,o.width*s,o.height*s],this.context.setAttribute("viewBox",this._viewBox.join(" "));var p=this._layerContainer;if(p.style.transform="",t.domCssMatrix){var l=t.getSize();parseInt(p.style.width)===l.width&&parseInt(p.style.height)===l.height||(p.style.width=l.width+"px",p.style.height=l.height+"px");var c=e.Util.join(t.domCssMatrix);p.style[h]="matrix3D("+c+")"}else e.DomUtil.removeTransform(p),(p.style.width||p.style.height)&&(p.style.width=null,p.style.height=null);var d=t.offsetPlatform();p.style.left=-d.x+"px",p.style.top=-d.y+"px"},t}()),l.registerRenderer("canvas",function(t){function r(){return n(this,r),i(this,t.apply(this,arguments))}return s(r,t),r.prototype.remove=function(){delete this._drawContext,t.prototype.remove.call(this)},r.prototype.getGeoProjection=function(){var t=this.getMap(),r=function(o,r){o[0]&&o[1]&&(o=[o[0],o[1]]);var n=t.coordinateToContainerPoint(new e.Coordinate(o,r));return this&&this.stream&&this.stream.point(n.x,n.y),[n.x,n.y]},n=this.layer.options.d3Version;return 3===n?r:4===n?o.geoTransform({point:r}):null},r.prototype.draw=function(){this.prepareCanvas(),this._predrawn||(this._armContext(),this._drawContext=this.layer.prepareToDraw(this.context,this.layer.getGeoProjection()),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawn=!0),this.layer.draw.apply(this.layer,[this.context,this.layer.getGeoProjection()].concat(this._drawContext)),this.completeRender()},r.prototype.drawOnInteracting=function(){this.draw()},r.prototype._armContext=function(){if(this.context){var t=this.getMap();this.context.arcInMeter=function(e,o,r,n,i,s){var a=t.distanceToPixel(r,0);return this.arc(e,o,a.width,n,i,s)},this.context.arcToInMeter=function(e,o,r,n,i){var s=t.distanceToPixel(i,0);return this.arcTo(e,o,r,n,s.width)},this.context.ellipse&&(this.context.ellispeInMeter=function(e,o,r,n,i,s,a,h){var p=t.distanceToPixel(r,n);return this.ellipse(e,o,p.width,p.height,i,s,a,h)}),this.context.rectInMeter=function(e,o,r,n){var i=t.distanceToPixel(r,n);return this.rect(e,o,i.width,i.height)}}},r}(e.renderer.CanvasRenderer)),t.D3Layer=l,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.d3 v0.2.0, requires maptalks@^0.23.0.")});